#!/usr/bin/env bash

# Libvirt group setup - adds wheel members to libvirt group

VERSION="1"
GROUP_NAME="libvirt"
STATE_FILE="/etc/custom-state-files/dx-libvirt-groups"

# Check if already ran with same version
if [[ -f "$STATE_FILE" ]] && [[ "$(cat "$STATE_FILE")" == "$VERSION" ]]; then
    echo "$GROUP_NAME group setup already completed (v$VERSION). Exiting..."
    exit 0
fi

echo "Running $GROUP_NAME group setup..."

# Function to add user to group
add_to_group() {
    local user="$1"
    local group="$2"

    if id -nG "$user" | grep -qw "$group"; then
        echo "User $user is already in group $group"
        return
    fi

    usermod -aG "$group" "$user" 2>/dev/null || echo "Warning: Could not add $user to $group"
}

# Get all wheel users
wheel_users=$(getent group wheel | cut -d ":" -f 4 | tr ',' '\n')

# Add wheel users to libvirt group
for user in $wheel_users; do
    echo "Adding user $user to $GROUP_NAME group..."
    add_to_group "$user" "$GROUP_NAME"
done

# Create state file
echo "$VERSION" > "$STATE_FILE"

echo "$GROUP_NAME group setup complete."
